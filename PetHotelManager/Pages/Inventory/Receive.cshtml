@page "/inventory/receive"
@model PetHotelManager.Pages.Inventory.ReceiveModel
@{
    ViewData["Title"] = "T·∫°o Phi·∫øu Nh·∫≠p kho";
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h1>üì• @ViewData["Title"]</h1>
    <a asp-page="/Products/Index" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Quay l·∫°i
    </a>
</div>
<hr />

<form id="receiptForm">
    <div class="card mb-3">
        <div class="card-header">
            <h5 class="mb-0">üìù Th√¥ng tin phi·∫øu nh·∫≠p</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="supplier" class="form-label">
                        Nh√† cung c·∫•p (*)
                        <span class="text-danger">*</span>
                    </label>
                    <input type="text"
                           id="supplier"
                           class="form-control"
                           placeholder="VD: C√¥ng ty D∆∞·ª£c ph·∫©m ABC"
                           required />
                    <small class="form-text text-muted">T√™n nh√† cung c·∫•p ho·∫∑c ngu·ªìn h√†ng</small>
                </div>

                <div class="col-md-6 mb-3">
                    <label for="notes" class="form-label">Ghi ch√∫</label>
                    <input type="text"
                           id="notes"
                           class="form-control"
                           placeholder="VD: L√¥ h√†ng th√°ng 11/2025" />
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-3">
        <div class="card-header">
            <h5 class="mb-0">üì¶ Chi ti·∫øt s·∫£n ph·∫©m nh·∫≠p</h5>
        </div>
        <div class="card-body">
            <div class="row align-items-end g-3 mb-3 p-3 border rounded bg-light">
                <div class="col-md-5">
                    <label class="form-label">S·∫£n ph·∫©m (*)</label>
                    <select id="productSelect" class="form-select" asp-items="Model.Products">
                        <option value="">-- Ch·ªçn s·∫£n ph·∫©m --</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">S·ªë l∆∞·ª£ng nh·∫≠p (*)</label>
                    <input type="number"
                           id="itemQuantity"
                           class="form-control"
                           value="1"
                           min="1" />
                </div>
                <div class="col-md-2">
                    <label class="form-label">Gi√° nh·∫≠p</label>
                    <input type="number"
                           id="unitPrice"
                           class="form-control"
                           placeholder="0"
                           step="1000" />
                </div>
                <div class="col-md-2">
                    <button type="button" id="addItemBtn" class="btn btn-success w-100">
                        <i class="bi bi-plus-circle"></i> Th√™m
                    </button>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 40%">S·∫£n ph·∫©m</th>
                            <th class="text-end" style="width: 15%">S·ªë l∆∞·ª£ng</th>
                            <th class="text-end" style="width: 20%">Gi√° nh·∫≠p</th>
                            <th class="text-end" style="width: 20%">Th√†nh ti·ªÅn</th>
                            <th class="text-center" style="width: 5%"></th>
                        </tr>
                    </thead>
                    <tbody id="receiptDetailsBody">
                        <tr id="emptyRow">
                            <td colspan="5" class="text-center text-muted py-4">
                                Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o. Vui l√≤ng th√™m s·∫£n ph·∫©m v√†o phi·∫øu nh·∫≠p.
                            </td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr class="table-secondary">
                            <th colspan="3" class="text-end">T·ªîNG C·ªòNG:</th>
                            <th class="text-end" id="totalAmount">0 ƒë</th>
                            <th></th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-between">
        <a asp-page="/Products/Index" class="btn btn-secondary">
            <i class="bi bi-x-circle"></i> H·ªßy
        </a>
        <button type="submit" class="btn btn-primary" id="submitBtn">
            <i class="bi bi-check-circle"></i> X√°c nh·∫≠n Nh·∫≠p kho
        </button>
    </div>
</form>

<!-- Modal Loading -->
<div class="modal fade" id="loadingModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-4">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5>ƒêang x·ª≠ l√Ω nh·∫≠p kho...</h5>
                <p class="mb-0 text-muted">Vui l√≤ng ch·ªù trong gi√¢y l√°t</p>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        (function() {
            'use strict';

            let receiptItems = [];
            let loadingModal;

            // Initialize
            document.addEventListener('DOMContentLoaded', function() {
                loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
                setupEventListeners();
            });

            function setupEventListeners() {
                // N√∫t "Th√™m s·∫£n ph·∫©m"
                document.getElementById('addItemBtn').addEventListener('click', addItem);

                // Cho ph√©p nh·∫•n Enter trong √¥ s·ªë l∆∞·ª£ng ƒë·ªÉ th√™m
                document.getElementById('itemQuantity').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addItem();
                    }
                });

                // Form submit
                document.getElementById('receiptForm').addEventListener('submit', handleSubmit);

                // Delegate event cho n√∫t x√≥a
                document.getElementById('receiptDetailsBody').addEventListener('click', function(e) {
                    if (e.target.classList.contains('remove-item-btn')) {
                        removeItem(e.target.dataset.productId);
                    }
                });
            }

            function addItem() {
                const productSelect = document.getElementById('productSelect');
                const quantity = parseInt(document.getElementById('itemQuantity').value);
                const unitPrice = parseFloat(document.getElementById('unitPrice').value) || 0;

                // Validation
                if (!productSelect.value) {
                    alert('‚ùå Vui l√≤ng ch·ªçn s·∫£n ph·∫©m!');
                    productSelect.focus();
                    return;
                }

                if (!quantity || quantity <= 0) {
                    alert('‚ùå S·ªë l∆∞·ª£ng ph·∫£i l·ªõn h∆°n 0!');
                    document.getElementById('itemQuantity').focus();
                    return;
                }

                const productId = parseInt(productSelect.value);
                const productName = productSelect.options[productSelect.selectedIndex].text;

                // Ki·ªÉm tra tr√πng
                if (receiptItems.some(item => item.productId === productId)) {
                    alert('‚ö†Ô∏è S·∫£n ph·∫©m n√†y ƒë√£ c√≥ trong phi·∫øu nh·∫≠p!');
                    return;
                }

                // Th√™m v√†o danh s√°ch
                receiptItems.push({
                    productId: productId,
                    productName: productName,
                    quantity: quantity,
                    unitPrice: unitPrice
                });

                // Render l·∫°i
                renderItems();

                // Reset form
                productSelect.value = '';
                document.getElementById('itemQuantity').value = '1';
                document.getElementById('unitPrice').value = '';
                productSelect.focus();
            }

            function removeItem(productId) {
                const id = parseInt(productId);
                receiptItems = receiptItems.filter(item => item.productId !== id);
                renderItems();
            }

            function renderItems() {
                const tbody = document.getElementById('receiptDetailsBody');
                const emptyRow = document.getElementById('emptyRow');

                if (receiptItems.length === 0) {
                    emptyRow.style.display = 'table-row';
                    updateTotal();
                    return;
                }

                emptyRow.style.display = 'none';

                let html = '';
                let total = 0;

                receiptItems.forEach(item => {
                    const subtotal = item.quantity * item.unitPrice;
                    total += subtotal;

                    html += `
                        <tr>
                            <td>${item.productName}</td>
                            <td class="text-end">${item.quantity.toLocaleString('vi-VN')}</td>
                            <td class="text-end">${item.unitPrice.toLocaleString('vi-VN')} ƒë</td>
                            <td class="text-end">${subtotal.toLocaleString('vi-VN')} ƒë</td>
                            <td class="text-center">
                                <button type="button"
                                        class="btn btn-sm btn-outline-danger remove-item-btn"
                                        data-product-id="${item.productId}">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });

                tbody.innerHTML = emptyRow.outerHTML + html;
                updateTotal();
            }

            function updateTotal() {
                const total = receiptItems.reduce((sum, item) => sum + (item.quantity * item.unitPrice), 0);
                document.getElementById('totalAmount').textContent = total.toLocaleString('vi-VN') + ' ƒë';
            }

            async function handleSubmit(e) {
                e.preventDefault();

                // Validation
                const supplier = document.getElementById('supplier').value.trim();
                if (!supplier) {
                    alert('‚ùå Vui l√≤ng nh·∫≠p t√™n nh√† cung c·∫•p!');
                    document.getElementById('supplier').focus();
                    return;
                }

                if (receiptItems.length === 0) {
                    alert('‚ùå Phi·∫øu nh·∫≠p ph·∫£i c√≥ √≠t nh·∫•t m·ªôt s·∫£n ph·∫©m!');
                    return;
                }

                // Confirm
                const confirmMsg = `X√°c nh·∫≠n nh·∫≠p kho:\n\n` +
                                   `üì¶ S·ªë s·∫£n ph·∫©m: ${receiptItems.length}\n` +
                                   `üìä T·ªïng s·ªë l∆∞·ª£ng: ${receiptItems.reduce((s, i) => s + i.quantity, 0)}\n` +
                                   `üè¢ Nh√† cung c·∫•p: ${supplier}\n\n` +
                                   `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën nh·∫≠p kho?`;

                if (!confirm(confirmMsg)) {
                    return;
                }

                // Prepare data
                const receiptData = {
                    supplier: supplier,
                    receiptDate: new Date().toISOString(),
                    notes: document.getElementById('notes').value.trim() || null,
                    lines: receiptItems.map(item => ({
                        productId: item.productId,
                        quantity: item.quantity,
                        unitPrice: item.unitPrice > 0 ? item.unitPrice : null,
                        notes: null
                    }))
                };

                console.log('üì§ Sending data:', receiptData);

                // Show loading
                loadingModal.show();
                document.getElementById('submitBtn').disabled = true;

                try {
                    const response = await fetch('/api/inventory/receive', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include', // G·ª≠i cookie
                        body: JSON.stringify(receiptData)
                    });

                    const data = await response.json();

                    if (response.ok) {
                        console.log('‚úÖ Success:', data);
                        alert(`‚úÖ ${data.message || 'Nh·∫≠p kho th√†nh c√¥ng!'}\n\n` +
                              `üì¶ S·∫£n ph·∫©m: ${data.totalProducts || receiptItems.length}\n` +
                              `üìä S·ªë l∆∞·ª£ng: ${data.totalQuantity || receiptItems.reduce((s, i) => s + i.quantity, 0)}`);

                        // Redirect v·ªÅ trang Products
                        window.location.href = '/products';
                    } else {
                        throw new Error(data.message || data.title || 'L·ªói kh√¥ng x√°c ƒë·ªãnh');
                    }
                } catch (error) {
                    console.error('‚ùå Error:', error);
                    alert('‚ùå L·ªói khi nh·∫≠p kho:\n\n' + error.message);
                } finally {
                    loadingModal.hide();
                    document.getElementById('submitBtn').disabled = false;
                }
            }
        })();
    </script>
}