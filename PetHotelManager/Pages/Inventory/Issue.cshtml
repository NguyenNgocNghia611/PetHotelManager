@page "/inventory/issue"
@model PetHotelManager.Pages.Inventory.IssueModel
@{
    ViewData["Title"] = "Xu·∫•t kho th·ªß c√¥ng";
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h1>üì§ @ViewData["Title"]</h1>
    <a asp-page="/Inventory/Stock" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Quay l·∫°i
    </a>
</div>
<hr />

<form id="issueForm">
    <div class="card mb-3">
        <div class="card-header">
            <h5 class="mb-0">üìù Th√¥ng tin phi·∫øu xu·∫•t</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="reason" class="form-label">
                        L√Ω do xu·∫•t kho (*)
                        <span class="text-danger">*</span>
                    </label>
                    <select id="reason" class="form-select" required>
                        <option value="">-- Ch·ªçn l√Ω do --</option>
                        <option value="Damaged">H√†ng h·ªèng</option>
                        <option value="Expired">H·∫øt h·∫°n</option>
                        <option value="Lost">M·∫•t m√°t</option>
                        <option value="Other">Kh√°c</option>
                    </select>
                </div>

                <div class="col-md-6 mb-3">
                    <label for="notes" class="form-label">Ghi ch√∫</label>
                    <input type="text"
                           id="notes"
                           class="form-control"
                           placeholder="Ghi ch√∫ b·ªï sung" />
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-3">
        <div class="card-header">
            <h5 class="mb-0">üì¶ Chi ti·∫øt s·∫£n ph·∫©m xu·∫•t</h5>
        </div>
        <div class="card-body">
            <div class="row align-items-end g-3 mb-3 p-3 border rounded bg-light">
                <div class="col-md-7">
                    <label class="form-label">S·∫£n ph·∫©m (*)</label>
                    <select id="productSelect" class="form-select" asp-items="Model.Products">
                        <option value="">-- Ch·ªçn s·∫£n ph·∫©m --</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">S·ªë l∆∞·ª£ng xu·∫•t (*)</label>
                    <input type="number"
                           id="itemQuantity"
                           class="form-control"
                           value="1"
                           min="1" />
                </div>
                <div class="col-md-2">
                    <button type="button" id="addItemBtn" class="btn btn-success w-100">
                        <i class="bi bi-plus-circle"></i> Th√™m
                    </button>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 70%">S·∫£n ph·∫©m</th>
                            <th class="text-end" style="width: 20%">S·ªë l∆∞·ª£ng</th>
                            <th class="text-center" style="width: 10%"></th>
                        </tr>
                    </thead>
                    <tbody id="issueDetailsBody">
                        <tr id="emptyRow">
                            <td colspan="3" class="text-center text-muted py-4">
                                Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o. Vui l√≤ng th√™m s·∫£n ph·∫©m v√†o phi·∫øu xu·∫•t.
                            </td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr class="table-secondary">
                            <th class="text-end">T·ªîNG S·ªê L∆Ø·ª¢NG:</th>
                            <th class="text-end" id="totalQuantity">0</th>
                            <th></th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-between">
        <a asp-page="/Inventory/Stock" class="btn btn-secondary">
            <i class="bi bi-x-circle"></i> H·ªßy
        </a>
        <button type="submit" class="btn btn-primary" id="submitBtn">
            <i class="bi bi-check-circle"></i> X√°c nh·∫≠n Xu·∫•t kho
        </button>
    </div>
</form>

<!-- Modal Loading -->
<div class="modal fade" id="loadingModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-4">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5>ƒêang x·ª≠ l√Ω xu·∫•t kho...</h5>
                <p class="mb-0 text-muted">Vui l√≤ng ch·ªù trong gi√¢y l√°t</p>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        (function() {
            'use strict';

            let issueItems = [];
            let loadingModal;

            // Initialize
            document.addEventListener('DOMContentLoaded', function() {
                loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
                setupEventListeners();
            });

            function setupEventListeners() {
                document.getElementById('addItemBtn').addEventListener('click', addItem);

                document.getElementById('itemQuantity').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addItem();
                    }
                });

                document.getElementById('issueForm').addEventListener('submit', handleSubmit);

                document.getElementById('issueDetailsBody').addEventListener('click', function(e) {
                    if (e.target.classList.contains('remove-item-btn')) {
                        removeItem(e.target.dataset.productId);
                    }
                });
            }

            function addItem() {
                const productSelect = document.getElementById('productSelect');
                const quantity = parseInt(document.getElementById('itemQuantity').value);

                // Validation
                if (!productSelect.value) {
                    alert('‚ùå Vui l√≤ng ch·ªçn s·∫£n ph·∫©m!');
                    productSelect.focus();
                    return;
                }

                if (!quantity || quantity <= 0) {
                    alert('‚ùå S·ªë l∆∞·ª£ng ph·∫£i l·ªõn h∆°n 0!');
                    document.getElementById('itemQuantity').focus();
                    return;
                }

                const productId = parseInt(productSelect.value);
                const productName = productSelect.options[productSelect.selectedIndex].text;

                // Ki·ªÉm tra tr√πng
                if (issueItems.some(item => item.productId === productId)) {
                    alert('‚ö†Ô∏è S·∫£n ph·∫©m n√†y ƒë√£ c√≥ trong phi·∫øu xu·∫•t!');
                    return;
                }

                // Th√™m v√†o danh s√°ch
                issueItems.push({
                    productId: productId,
                    productName: productName,
                    quantity: quantity
                });

                // Render l·∫°i
                renderItems();

                // Reset form
                productSelect.value = '';
                document.getElementById('itemQuantity').value = '1';
                productSelect.focus();
            }

            function removeItem(productId) {
                const id = parseInt(productId);
                issueItems = issueItems.filter(item => item.productId !== id);
                renderItems();
            }

            function renderItems() {
                const tbody = document.getElementById('issueDetailsBody');
                const emptyRow = document.getElementById('emptyRow');

                if (issueItems.length === 0) {
                    emptyRow.style.display = 'table-row';
                    updateTotal();
                    return;
                }

                emptyRow.style.display = 'none';

                let html = '';
                let totalQty = 0;

                issueItems.forEach(item => {
                    totalQty += item.quantity;

                    html += `
                        <tr>
                            <td>${item.productName}</td>
                            <td class="text-end">${item.quantity.toLocaleString('vi-VN')}</td>
                            <td class="text-center">
                                <button type="button"
                                        class="btn btn-sm btn-outline-danger remove-item-btn"
                                        data-product-id="${item.productId}">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });

                tbody.innerHTML = emptyRow.outerHTML + html;
                updateTotal();
            }

            function updateTotal() {
                const total = issueItems.reduce((sum, item) => sum + item.quantity, 0);
                document.getElementById('totalQuantity').textContent = total.toLocaleString('vi-VN');
            }

            async function handleSubmit(e) {
                e.preventDefault();

                // Validation
                const reason = document.getElementById('reason').value.trim();
                if (!reason) {
                    alert('‚ùå Vui l√≤ng ch·ªçn l√Ω do xu·∫•t kho!');
                    document.getElementById('reason').focus();
                    return;
                }

                if (issueItems.length === 0) {
                    alert('‚ùå Phi·∫øu xu·∫•t ph·∫£i c√≥ √≠t nh·∫•t m·ªôt s·∫£n ph·∫©m!');
                    return;
                }

                // Confirm
                const confirmMsg = `X√°c nh·∫≠n xu·∫•t kho:\n\n` +
                                   `üì¶ S·ªë s·∫£n ph·∫©m: ${issueItems.length}\n` +
                                   `üìä T·ªïng s·ªë l∆∞·ª£ng: ${issueItems.reduce((s, i) => s + i.quantity, 0)}\n` +
                                   `‚ùó L√Ω do: ${reason}\n\n` +
                                   `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën xu·∫•t kho?`;

                if (!confirm(confirmMsg)) {
                    return;
                }

                // Prepare data
                const issueData = {
                    reason: reason,
                    notes: document.getElementById('notes').value.trim() || null,
                    lines: issueItems.map(item => ({
                        productId: item.productId,
                        quantity: item.quantity,
                        notes: null
                    }))
                };

                console.log('üì§ Sending data:', issueData);

                // Show loading
                loadingModal.show();
                document.getElementById('submitBtn').disabled = true;

                try {
                    const response = await fetch('/api/inventory/issue', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify(issueData)
                    });

                    const data = await response.json();

                    if (response.ok) {
                        console.log('‚úÖ Success:', data);
                        alert(`‚úÖ ${data.message || 'Xu·∫•t kho th√†nh c√¥ng!'}\n\n` +
                              `üì¶ S·∫£n ph·∫©m: ${data.totalProducts || issueItems.length}\n` +
                              `üìä S·ªë l∆∞·ª£ng: ${data.totalQuantity || issueItems.reduce((s, i) => s + i.quantity, 0)}`);

                        window.location.href = '/inventory/stock';
                    } else {
                        throw new Error(data.message || data.Message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh');
                    }
                } catch (error) {
                    console.error('‚ùå Error:', error);
                    alert('‚ùå L·ªói khi xu·∫•t kho:\n\n' + error.message);
                } finally {
                    loadingModal.hide();
                    document.getElementById('submitBtn').disabled = false;
                }
            }
        })();
    </script>
}
