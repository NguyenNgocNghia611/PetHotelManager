@page
@model PetHotelManager.Pages.MedicalRecords.CreateModel
@{
    ViewData["Title"] = "Tạo hồ sơ khám";
}

<h2 class="mb-3">Tạo hồ sơ khám</h2>

@if (!string.IsNullOrEmpty(Model.Error))
{
    <div class="alert alert-danger">@Model.Error</div>
}
@if (!string.IsNullOrEmpty(Model.Success))
{
    <div class="alert alert-success">@Model.Success</div>
}

<form method="post" class="row g-3">
    <div class="col-md-4">
        <label class="form-label">Thú cưng</label>
        <select class="form-select" asp-for="Form.PetId" required>
            <option value="">-- chọn --</option>
            @foreach (var p in Model.Pets)
            {
                <option value="@p.Id" selected="@(Model.Form.PetId == p.Id ? "selected" : null)">
                    @p.Name (@p.Species) - @p.HealthStatus
                </option>
            }
        </select>
        <span class="text-danger" asp-validation-for="Form.PetId"></span>
    </div>

    <div class="col-md-4">
        <label class="form-label">Ngày khám</label>
        <input asp-for="Form.ExaminationDate" type="datetime-local" class="form-control" />
        <span class="text-danger" asp-validation-for="Form.ExaminationDate"></span>
    </div>

    <div class="col-md-12">
        <label class="form-label">Triệu chứng</label>
        <textarea asp-for="Form.Symptoms" rows="2" class="form-control"></textarea>
    </div>

    <div class="col-md-12">
        <label class="form-label">Chẩn đoán</label>
        <textarea asp-for="Form.Diagnosis" rows="2" class="form-control"></textarea>
    </div>

    <div class="col-12">
        <h5 class="mt-3">Kê đơn thuốc</h5>

        <table class="table table-sm">
            <thead>
                <tr>
                    <th>Sản phẩm</th>
                    <th>Số lượng</th>
                    <th>Liều dùng (Dosage)</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
            @for (int i = 0; i < Model.Form.Prescriptions.Count; i++)
            {
                <tr>
                    <td>
                        <select class="form-select" name="Form.Prescriptions[@i].ProductId">
                            <option value="">-- chọn --</option>
                            @foreach (var prod in Model.Products)
                            {
                                <option value="@prod.Id" selected="@(Model.Form.Prescriptions[i].ProductId == prod.Id ? "selected" : null)">
                                    @prod.Name (Còn: @prod.StockQuantity @prod.Unit)
                                </option>
                            }
                        </select>
                    </td>
                    <td>
                        <input class="form-control form-control-sm" type="number" min="1" name="Form.Prescriptions[@i].Quantity" value="@Model.Form.Prescriptions[i].Quantity" />
                    </td>
                    <td>
                        <input class="form-control form-control-sm" name="Form.Prescriptions[@i].Dosage" value="@Model.Form.Prescriptions[i].Dosage" />
                    </td>
                    <td>
                        <form method="post" asp-page-handler="RemovePrescription">
                            <input type="hidden" name="index" value="@i" />
                            <button class="btn btn-sm btn-outline-danger" type="submit">&times;</button>
                        </form>
                    </td>
                </tr>
            }
            </tbody>
        </table>

        <div>
            <form method="post" asp-page-handler="AddPrescription">
                <button class="btn btn-sm btn-outline-primary" type="submit">+ Thêm dòng</button>
            </form>
        </div>
    </div>

    <div class="col-12 d-flex gap-2 mt-3">
        <button class="btn btn-success" type="submit">Lưu hồ sơ</button>
        <a href="/MedicalRecords" class="btn btn-outline-secondary">Quay lại</a>
    </div>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}